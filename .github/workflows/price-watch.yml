name: VietJet Price Watch

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */2 * * *"      # má»—i 2 giá» (UTC)
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/price-watch.yml"
      - "requirements.txt"
      - "vietjet_watcher.py"

jobs:
  watch:
    runs-on: ubuntu-latest
    permissions:
      contents: write           # Ä‘á»ƒ commit thÆ° má»¥c state
    strategy:
      fail-fast: false
      matrix:
        route:
          - { ORIGIN: "HAN", DEST: "SGN", DATE: "2025-09-20", CURRENCY: "VND", PRICE_DROP_NOTIFY: "50000" }
          # thÃªm tuyáº¿n á»Ÿ Ä‘Ã¢y náº¿u cáº§n

    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
      ORIGIN: ${{ matrix.route.ORIGIN }}
      DEST: ${{ matrix.route.DEST }}
      DATE: ${{ matrix.route.DATE }}
      CURRENCY: ${{ matrix.route.CURRENCY }}
      PRICE_DROP_NOTIFY: ${{ matrix.route.PRICE_DROP_NOTIFY }}

    steps:
      - name: Checkout (with credentials)
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # Ä‘á»ƒ git push state

      - name: Show route
        run: |
          echo "Route: $ORIGIN -> $DEST on $DATE ($CURRENCY)"
          test -n "$BOT_TOKEN" || (echo "::error::Missing BOT_TOKEN"; exit 1)
          test -n "$CHAT_ID"   || (echo "::error::Missing CHAT_ID"; exit 1)

      - name: Ping start (debug Telegram)
        run: |
          set -euxo pipefail
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="Báº¯t Ä‘áº§u job ðŸ“¦ $(date -u +'%Y-%m-%d %H:%M:%S UTC') â€“ $ORIGINâ†’$DEST $DATE" \
            -d disable_web_page_preview=true | tee /tmp/start.json
          echo "::notice::Start ping: $(cat /tmp/start.json)"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (Playwright + Chromium)
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run watcher
        run: |
          set -euxo pipefail
          python vietjet_watcher.py
